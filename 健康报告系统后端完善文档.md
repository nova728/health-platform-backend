# 健康报告系统后端完善文档

## 概述
根据前端代码需求，我们完善了健康报告系统的后端实现，主要包括健康数据分析服务、控制器API和数据库映射层。

## 主要更改

### 1. 健康报告分析服务 (HealthReportAnalysisService.java)

#### 新增功能：
- **generateHealthReport(Integer userId)**: 为用户生成完整的健康报告
- **getLatestReport(Integer userId)**: 获取用户最新的健康报告
- **getReportHistory(Integer userId, Date startDate, Date endDate)**: 获取用户的健康报告历史

#### 改进的分析算法：
- **BMI分析**: 根据国际标准分类（偏瘦、正常、超重、肥胖）
- **血压分析**: 细化分类（低血压、正常、偏高、高血压）
- **心率分析**: 静息心率评估（偏低、正常、偏高）
- **睡眠质量评估**: 基于睡眠时长和深睡眠比例的综合评估
- **运动分析**: 基于WHO推荐标准的运动量评估

#### 健康建议生成：
- 根据各项指标异常情况生成个性化健康建议
- 支持JSON格式存储和传输
- 涵盖饮食、运动、作息等多个维度的建议

#### 评分系统：
- 总分100分制
- BMI评分（25分）
- 血压评分（20分）
- 心率评分（15分）
- 睡眠评分（20分）
- 运动评分（20分）

### 2. 控制器更新 (HealthReportController.java)

#### 新增API端点：

**POST /api/health-report/{userId}/generate-report**
- 为指定用户生成新的健康报告
- 返回完整的健康报告数据

**GET /api/health-report/{userId}/latest**
- 获取用户最新的健康报告
- 用于前端健康概览页面

**GET /api/health-report/{userId}/history**
- 获取用户的健康报告历史记录
- 支持日期范围筛选
- 用于前端历史报告页面

#### 错误处理：
- 统一的错误响应格式
- 详细的错误日志记录
- 参数验证和异常捕获

### 3. 数据库映射层更新 (HealthReportMapper.java)

#### 新增方法：
- **findByUserIdAndDateRange**: 支持基于日期范围的报告查询
- 兼容Date类型参数，匹配前端需求

#### 数据库字段映射：
- 支持所有前端需要的健康指标字段
- JSON格式存储健康建议和异常指标
- 软删除支持

## 前端对接说明

### API接口说明

#### 1. 生成健康报告
```
POST /api/health-report/{userId}/generate-report
```
**响应格式：**
```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "id": 1,
    "userId": 123,
    "reportTime": "2025-05-28T10:30:00",
    "bmi": 22.5,
    "bmiStatus": "正常",
    "weight": 70.0,
    "height": 175.0,
    "systolic": 120.0,
    "diastolic": 80.0,
    "bloodPressureStatus": "正常",
    "heartRate": 75.0,
    "heartRateStatus": "正常",
    "weeklyExerciseDuration": 180.0,
    "weeklyExerciseCount": 5,
    "weeklyCaloriesBurned": 1500.0,
    "exerciseGoalAchieved": true,
    "dailySteps": 8000,
    "dailyDistance": 6.5,
    "averageSleepDuration": 7.5,
    "deepSleepPercentage": 28.0,
    "lightSleepPercentage": 45.0,
    "remSleepPercentage": 27.0,
    "sleepQuality": "优",
    "overallScore": 85,
    "healthSuggestions": "[\"您的健康状况良好...\"]",
    "abnormalIndicators": "[]"
  }
}
```

#### 2. 获取最新报告
```
GET /api/health-report/{userId}/latest
```

#### 3. 获取历史报告
```
GET /api/health-report/{userId}/history?startDate=2025-01-01T00:00:00Z&endDate=2025-05-28T23:59:59Z
```

### 前端集成要点

1. **健康评分展示**: 使用 `overallScore` 字段进行圆环进度条展示
2. **异常指标解析**: `abnormalIndicators` 字段为JSON数组，需要解析后展示
3. **健康建议解析**: `healthSuggestions` 字段为JSON数组，包含个性化建议
4. **状态分类**: 各项指标都有对应的状态字段，可用于颜色标识
5. **日期格式**: 使用ISO 8601格式进行日期时间传输

## 数据库表结构

### health_reports 表
主要字段包括：
- 基础信息：user_id, report_time
- 身体指标：bmi, weight, height, bmi_status
- 血压心率：systolic, diastolic, heart_rate, blood_pressure_status, heart_rate_status
- 运动数据：weekly_exercise_duration, weekly_exercise_count, weekly_calories_burned, daily_steps, daily_distance
- 睡眠数据：average_sleep_duration, deep_sleep_percentage, light_sleep_percentage, rem_sleep_percentage, sleep_quality
- 评估结果：overall_score, health_suggestions, abnormal_indicators

## 部署说明

1. 确保所有依赖的服务（HealthDataCollectorService等）正常运行
2. 数据库表结构需要与实体类字段匹配
3. JSON序列化配置正确
4. 日志配置适当，便于问题排查

## 扩展性考虑

1. **算法优化**: 健康评分算法可根据医学标准进一步优化
2. **个性化建议**: 可集成AI服务提供更个性化的健康建议
3. **报告模板**: 可支持多种报告模板和格式
4. **数据分析**: 可添加趋势分析和预测功能

## 测试建议

1. 单元测试覆盖所有分析算法
2. 集成测试验证API接口功能
3. 性能测试确保大量数据处理性能
4. 边界条件测试（数据缺失、异常值等）
